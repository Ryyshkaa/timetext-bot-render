"""
ü§ñ FIB BOT - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è Render
–° –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UTC –≤—Ä–µ–º–µ–Ω–µ–º –∏ keep-alive
"""

import requests
import json
import time
import os
from datetime import datetime
import schedule
import threading
import logging
from dotenv import load_dotenv
from flask import Flask, jsonify
from threading import Thread

# ===================== FLASK –î–õ–Ø RENDER =====================
app = Flask(__name__)

@app.route('/')
def home():
    return "ü§ñ FIB Bot —Ä–∞–±–æ—Ç–∞–µ—Ç! –í—Ä–µ–º—è UTC, keep-alive –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω"


def get_job_name(job):
    func_name = job.job_func.__name__
    if "str" in func_name: return "STR"
    if "atf" in func_name: return "ATF"
    if "fpb" in func_name: return "FPB"
    if "cid" in func_name: return "CID"
    if "keep" in func_name: return "Keep-alive"
    return "Unknown"

@app.route('/health')
def health():
    return jsonify({
        "status": "ok",
        "time_utc": datetime.utcnow().strftime("%H:%M:%S"),
        "time_msk": (datetime.utcnow().hour + 3) % 24,
        "next_messages": get_next_messages()
    })

def get_next_messages():
    jobs = list(schedule.get_jobs())
    if not jobs:
        return "–ù–µ—Ç –∑–∞–¥–∞—á"
    next_job = min(jobs, key=lambda x: x.next_run)
    return f"–°–ª–µ–¥—É—é—â–µ–µ: {get_job_name(next_job)} –≤ {next_job.next_run.strftime('%H:%M UTC')}"

# ===================== –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–ê =====================
load_dotenv()

WEBHOOK_URL = os.getenv("WEBHOOK_URL", "https://discord.com/api/webhooks/1467255626240495740/Nk1PW-RU2f3ORjQd4Hmy-Jgc_1NZtw4Z2lXakfgbHjDb5ezziVgvGi75tsdriOdP7DfG")

ROLES = {
    "FIB": os.getenv("ROLE_FIB", "1242210100584910858"),
    "STR": os.getenv("ROLE_STR", "1389060594161942558"),
    "ATF": os.getenv("ROLE_ATF", "1242213554761764995"),
    "FPB": os.getenv("ROLE_FPB", "1242216678507417741"),
    "CID": os.getenv("ROLE_CID", "1242214655733141514"),
}

CHANNELS = {
    "APPLICATIONS_STR": os.getenv("CHANNEL_APPLICATIONS_STR", "1263503399442317342"),
    "APPLICATIONS_ATF": os.getenv("CHANNEL_APPLICATIONS_ATF", "1263503451640299662"),
    "APPLICATIONS_FPB": os.getenv("CHANNEL_APPLICATIONS_FPB", "1263503533710246062"),
    "APPLICATIONS_CID": os.getenv("CHANNEL_APPLICATIONS_CID", "1263503558813286420"),
    "SERVER_ID": os.getenv("SERVER_ID", "714752380616441878")
}

# ===================== –í–ê–ñ–ù–û: –í–†–ï–ú–Ø –í UTC =====================
# –ú–æ—Å–∫–≤–∞ UTC+3: –≤—ã—á–∏—Ç–∞–µ–º 3 —á–∞—Å–∞
SCHEDULES = {
    "str": ["07:00"],    # –ú–°–ö: 10:00
    "atf": ["08:30"],   # –ú–°–ö: 11:30
    "fpb": ["10:00"],    # –ú–°–ö: 13:00
    "cid": ["11:30"]    # –ú–°–ö: 14:30
}

# ===================== –¢–ï–ö–°–¢–´ –°–û–û–ë–©–ï–ù–ò–ô =====================
MESSAGES = {
    "str": {
        "name": "Selection, Training and Regulation",
        "content": """**–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, —É–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏** {FIB} 

üåü **–û—Ç–¥–µ–ª STR –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–≤–æ–∏ –¥–≤–µ—Ä–∏ –¥–ª—è —Å–∞–º—ã—Ö –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã—Ö –∏ –ø—Ä–µ–¥–∞–Ω–Ω—ã—Ö –¥–µ–ª—É!** –ì–æ—Ç–æ–≤—ã –ª–∏ –≤—ã —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –∫–æ–º–∞–Ω–¥—ã –º–µ—á—Ç—ã?

**–ß—Ç–æ –≤–∞—Å –∂–¥–µ—Ç:**

üí∞ **–ë—ã—Å—Ç—Ä—ã–π –≤–∑–ª–µ—Ç –ø–æ –∫–∞—Ä—å–µ—Ä–Ω–æ–π –ª–µ—Å—Ç–Ω–∏—Ü–µ:** –í–∞—à–∏ —É—Å–∏–ª–∏—è –±—É–¥—É—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–º–µ—á–µ–Ω—ã –∏ —â–µ–¥—Ä–æ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω—ã!
ü§ù **–î—Ä—É–∂–Ω—ã–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤:** –ó–∞–±—É–¥—å—Ç–µ –æ–± –∏–Ω—Ç—Ä–∏–≥–∞—Ö –∏ —Å–∫–ª–æ–∫–∞—Ö ‚Äî —É –Ω–∞—Å —Ü–∞—Ä–∏—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –≤–∑–∞–∏–º–æ–ø–æ–º–æ—â–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏!
üèûÔ∏è **–†–∞–±–æ—Ç–∞ –≤ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ:** –ó–∞–±—É–¥—å—Ç–µ –æ —Å–∫—É—á–Ω—ã—Ö –±—É–¥–Ω—è—Ö, –≤–∞—Å –∂–¥—É—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ –±–ª–∞–≥–æ —à—Ç–∞—Ç–∞!
üåä **–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å–∞–º:** –í –≤–∞—à–µ–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏ –±—É–¥–µ—Ç –≤–æ–¥–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –≤—ã –º–æ–≥–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ª—é–±—ã–µ –≤—ã–∑–æ–≤—ã!

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –≤–∞—Å:**

üß† **–ó–Ω–∞–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–≤ —à—Ç–∞—Ç–∞:** –ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ!
üöó **–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ:** –ë–µ–∑ –Ω–µ–≥–æ –Ω–∏–∫—É–¥–∞!
üé§ **–ß–µ—Ç–∫–∞—è —Ä–µ—á—å:** –í–∞–∂–Ω–æ —É–º–µ—Ç—å –¥–æ–Ω–æ—Å–∏—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏ –¥–æ –æ–∫—Ä—É–∂–∞—é—â–∏–º.
‚ôæÔ∏è **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –æ–±—É—á–µ–Ω–∏—é:** –ú–∏—Ä –Ω–µ —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ, –∏ –º—ã —Ç–æ–∂–µ! –†–∞–∑–≤–∏–≤–∞–π—Ç–µ—Å—å –≤–º–µ—Å—Ç–µ —Å –Ω–∞–º–∏!

**–í–∞—à–∞ –º–∏—Å—Å–∏—è:**

üé£ **–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –æ–±—É—á–µ–Ω–∏—è –∞–∫–∞–¥–µ–º–∏–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ë—é—Ä–æ**
üìú **–í–µ–¥–µ–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–æ–≥–æ –Ω–∞–¥–∑–æ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ë—é—Ä–æ**
üö® **–ó–∞–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–∞—Ä—É—à–∏—Ç–µ–ª–µ–π:** –ü—Ä–µ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–µ –ø—Ä–æ–π–¥–µ—Ç!

**–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ {STR}!** 
üéØ **–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –∫–∞–Ω–∞–ª–µ:** {APPLICATIONS_STR}

**–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –æ—Ç–¥–µ–ª–∞ <@&1389060880968192020>**""",
        "roles": ["FIB", "STR"],
        "channels": ["APPLICATIONS_STR"]
    },
    "atf": {
        "name": "Anti-Terror Force",
        "content": """**–£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏** {FIB}
üîπ **–ù–∞–±–æ—Ä –≤ –æ—Ç–¥–µ–ª ATF –æ—Ç–∫—Ä—ã—Ç!** üîπ

–ï—Å–ª–∏ —Ç—ã –æ–±–ª–∞–¥–∞–µ—à—å 3 –ø–æ—Ä—è–¥–∫–æ–≤—ã–º —Ä–∞–Ω–≥–æ–º –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≥–æ—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞—Ç—å, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∏—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ ‚Äî —É —Ç–µ–±—è –µ—Å—Ç—å —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é —ç–ª–∏—Ç—ã.

{ATF} ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ. –≠—Ç–æ –∫–æ–º–∞–Ω–¥–∞, –¥–µ–π—Å—Ç–≤—É—é—â–∞—è –≤ —Å–∞–º—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö. –ú—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, –∫—Ç–æ –≥–æ—Ç–æ–≤ –±—Ä–∞—Ç—å –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –Ω–µ –±–æ–∏—Ç—Å—è —Ç—Ä—É–¥–Ω–æ—Å—Ç–µ–π –∏ –≤—Å–µ–≥–¥–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö —Å–ª—É–∂–±—ã.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:**

üîπ –ú–∏–Ω–∏–º—É–º 3 –ø–æ—Ä—è–¥–∫–æ–≤—ã–π —Ä–∞–Ω–≥
üîπ –û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –∂–µ–ª–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤ —Å–æ—Å—Ç–∞–≤–µ ATF
üîπ –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, –ø—É–Ω–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, —Å–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—É–±–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
üîπ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –∏ –ø–æ —É—Å—Ç–∞–≤—É

**–ß—Ç–æ –¥–∞—ë—Ç —Å–ª—É–∂–±–∞ –≤ ATF:**

üî∫ –†–∞–±–æ—Ç–∞ –Ω–∞ –ø–µ—Ä–µ–¥–æ–≤–æ–π
üî∫ –¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
üî∫ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —ç–ª–∏—Ç–Ω–æ–≥–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
üî∫ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ø–ª–æ—á—ë–Ω–Ω–æ–≥–æ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–∞

**–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ —Å–≤–æ–π —à–∞–Ω—Å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞** {ATF}! 
üéØ **–ü–æ–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –∫–∞–Ω–∞–ª–µ:** {APPLICATIONS_ATF}

**–•–æ—á–µ—à—å —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –ª—É—á—à–∏—Ö? –ü–∏—à–∏!!!!**

**–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –æ—Ç–¥–µ–ª–∞ <@&966268913170141194>""",
        "roles": ["FIB", "ATF"],
        "channels": ["APPLICATIONS_ATF"]
    },
    "fpb": {
        "name": "Federal Patrol Bureau",
        "content": """**–£–≤–∞–∂–∞–µ–º—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –±—é—Ä–æ** {FIB}
—Ö–æ—Ç–∏–º —Å–æ–æ–±—â–∏—Ç—å —á—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç **–ù–∞–±–æ—Ä –≤ –æ—Ç–¥–µ–ª: Federal Patrol Bureau** ({FPB}),!

–ú—ã –∑–∞–Ω–∏–º–∞–µ–º—Å—è –ø–∞—Ç—Ä—É–ª—è–º–∏, –ø–æ–º–æ–≥–∞–µ–º –ª—é–¥—è–º –æ—Å–≤–æ–∏—Ç—å—Å—è
–∏ –≤–ª–∏—Ç—å—Å—è –≤ –∂–∏–∑–Ω—å –æ—Ç–¥–µ–ª–∞!

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã:**
- –ó–Ω–∞–Ω–∏–µ –æ—Å–Ω–æ–≤ –£–ê–ö, –ó–∞–∫–æ–Ω –æ "FIB", –ó–∞–∫–æ–Ω –æ "–Æ—Ä–∏—Å–¥–∏–∫—Ü–∏–∏"
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö
- –ñ–µ–ª–∞–Ω–∏–µ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ —Å –æ—Ç–¥–µ–ª–æ–º

**–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç –Ω–∞—Å:**
- –ü—Ä–∏—è—Ç–Ω—ã–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç –∫–æ–º–ø–∞–Ω–∏—é
- –î–æ–±—Ä—ã–π —Å—Ç–∞—Ä—à–∏–π —Å–æ—Å—Ç–∞–≤, –ø—Ä–æ—Ç—è–≥–∏–≤–∞—é—â–∏–π —Ä—É–∫—É –ø–æ–º–æ—â–∏
- –ö—Ä–∞—Å–∏–≤–∞—è –∏ –ø—Ä–∏—è—Ç–Ω–∞—è –≥–ª–∞–∑—É —Ñ–æ—Ä–º–∞

**–° –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥—ë–º —Ç–≤–æ–µ–π –∑–∞—è–≤–∫–∏!**
üéØ **–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –º–æ–∂–Ω–æ –≤ –∫–∞–Ω–∞–ª–µ:** {APPLICATIONS_FPB}

**–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –æ—Ç–¥–µ–ª–∞ <@&1106939082313039922>""",
        "roles": ["FIB", "FPB"],
        "channels": ["APPLICATIONS_FPB"]
    },
    "cid": {
        "name": "Criminal Investigation Division",
        "content": """**–í–Ω–∏–º–∞–Ω–∏–µ {FIB} !**

üìö **–û—Ç–¥–µ–ª {CID} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞–±–æ—Ä!** –í–æ–ø—Ä–æ—Å –≤ —Ç–æ–º, —Ö–≤–∞—Ç–∏—Ç –ª–∏ —É –≤–∞—Å –ñ–µ–ª–∞–Ω–∏—è, —Ç.–∫. —É –Ω–∞—Å –≤—ã –Ω–µ –±—É–¥–µ—Ç–µ —Å–∏–¥–µ—Ç—å –±–µ–∑ –¥–µ–ª–∞! 

–ù–∞—à –æ—Ç–¥–µ–ª –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∏ —Ç–æ–ª—å–∫–æ –æ—Ç –≤–∞—Å –±—É–¥–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç FIB –¥–ª—è –æ–±—â–µ—Å—Ç–≤–∞.

**–ß—Ç–æ –º—ã –≤–∞–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:**

‚Ä¢ ü™∂ **–õ—ë–≥–∫—É—é –°–∏—Å—Ç–µ–º—É –ø–æ–≤—ã—à–µ–Ω–∏—è**
‚Ä¢ üì£ **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±–æ—Ä–æ—Ç—å—Å—è —Å –ø—Ä–µ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é "—é–µ–∑ –∫—Ä–æ–≤–∏ –Ω–∞ —Ä—É–∫–∞—Ö"**
‚Ä¢ üí∏ **–•–æ—Ä–æ—à–∏–µ –ø—Ä–µ–º–∏–∏ –∑–∞ —Ä–∞–±–æ—Ç—É**
‚Ä¢ üìà **–ë—ã—Å—Ç—Ä—ã–π –ö–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç**

**–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –≤–∞—Å?**

‚Ä¢ –ñ–µ–ª–∞–Ω–∏–µ –†–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –±–ª–∞–≥–æ —Ñ—Ä–∞–∫—Ü–∏–∏
‚Ä¢ (–ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏) –∏–º–µ—Ç—å –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã –≤ —Å—Ö–æ–∂–∏—Ö –æ—Ç–¥–µ–ª–∞—Ö
‚Ä¢ –£–¥–µ–ª—è—Ç—å —Ä–∞–±–æ—Ç–µ –≤—Ä–µ–º—è 

**–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –æ—Ç–¥–µ–ª–∞ <@&966269084129951784>""",
        "roles": ["FIB", "CID"],
        "channels": ["APPLICATIONS_CID"]
    }
}

# ===================== –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–ï =====================
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s UTC - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

# ===================== –§–£–ù–ö–¶–ò–ò =====================
def format_role_mention(role_key):
    return f"<@&{ROLES.get(role_key, role_key)}>" if role_key in ROLES else f"@{role_key}"

def format_channel_mention(channel_key):
    return f"<#{CHANNELS.get(channel_key, channel_key)}>" if channel_key in CHANNELS else f"#{channel_key}"

def prepare_message(message_key):
    msg_data = MESSAGES.get(message_key)
    if not msg_data:
        return ""
    
    content = msg_data["content"]
    for role in msg_data.get("roles", []):
        content = content.replace(f"{{{role}}}", format_role_mention(role))
    for channel in msg_data.get("channels", []):
        content = content.replace(f"{{{channel}}}", format_channel_mention(channel))
    
    return content

def send_webhook(content, username="FIB Bot"):
    if not WEBHOOK_URL:
        logger.error("‚ùå –ù–µ—Ç WEBHOOK_URL")
        return False
    
    data = {
        "content": content,
        "username": username,
        "avatar_url": os.getenv("BOT_AVATAR", "https://imgur.com/a/70K4fGM")
    }
    
    try:
        response = requests.post(WEBHOOK_URL, json=data, timeout=10)
        if response.status_code in [200, 204]:
            logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {username}")
            return True
        else:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ {response.status_code}")
            return False
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
        return False

def send_rd():
    content = prepare_message("str")
    return send_webhook(content, "Selection, Training and Regulation")

def send_seb():
    content = prepare_message("atf")
    return send_webhook(content, "Anti-Terror Force")

def send_pb():
    content = prepare_message("fpb")
    return send_webhook(content, "Federal Patrol Bureau")

def send_rdb():
    content = prepare_message("cid")
    return send_webhook(content, "Criminal Investigation Division")

# ===================== KEEP-ALIVE –î–õ–Ø RENDER =====================
def keep_alive_ping():
    """–í–ê–ñ–ù–û: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–Ω Render"""
    logger.info("üîÑ Keep-alive: –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω")

# ===================== –ù–ê–°–¢–†–û–ô–ö–ê –†–ê–°–ü–ò–°–ê–ù–ò–Ø =====================
def setup_schedule():
    schedule.clear()
    
    # –í–ê–ñ–ù–û: Keep-alive –∫–∞–∂–¥—ã–µ 14 –º–∏–Ω—É—Ç (–º–µ–Ω—å—à–µ 15!)
    schedule.every(5).minutes.do(keep_alive_ping)
    
    # –†–ê–°–ü–ò–°–ê–ù–ò–ï –í UTC!
    # STR
    for t in SCHEDULES["str"]:
        schedule.every().day.at(t).do(send_rd)
        logger.info(f"üìÖ STR –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # ATF
    for t in SCHEDULES["atf"]:
        schedule.every().day.at(t).do(send_seb)
        logger.info(f"üìÖ ATF –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # FPB
    for t in SCHEDULES["fpb"]:
        schedule.every().day.at(t).do(send_pb)
        logger.info(f"üìÖ FPB –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    # CID
    for t in SCHEDULES["cid"]:
        schedule.every().day.at(t).do(send_rdb)
        logger.info(f"üìÖ CID –≤ {t} UTC ({int(t[:2])+3}:{t[3:]} –ú–°–ö)")
    
    logger.info(f"‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. –ó–∞–¥–∞—á: {len(schedule.get_jobs())}")


# ===================== –û–°–ù–û–í–ù–û–ô –ü–õ–ê–ù–ò–†–û–í–©–ò–ö =====================
def run_scheduler():
    """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –±–æ—Ç–∞"""
    logger.info("üöÄ FIB Bot –∑–∞–ø—É—â–µ–Ω (UTC –≤—Ä–µ–º—è)")
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    setup_schedule()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    send_webhook("ü§ñ FIB Bot –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UTC –≤—Ä–µ–º–µ–Ω–µ–º", "–°–∏—Å—Ç–µ–º–∞")
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    while True:
        try:
            schedule.run_pending()
            time.sleep(30)  # 58 —Å–µ–∫—É–Ω–¥
            
            # –õ–æ–≥ –∫–∞–∂–¥—ã–π —á–∞—Å
            if datetime.now().minute == 0:
                logger.info(f"‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC: {datetime.utcnow().strftime('%H:%M')}")
                
        except KeyboardInterrupt:
            break
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            time.sleep(60)

# ===================== –ó–ê–ü–£–°–ö FLASK =====================
def run_flask_server():
    """–ó–∞–ø—É—Å–∫–∞–µ–º Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è Render"""
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port, debug=False, use_reloader=False)

# ===================== –ì–õ–ê–í–ù–´–ô –ó–ê–ü–£–°–ö =====================
if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = Thread(target=run_flask_server, daemon=True)
    flask_thread.start()
    
    # –î–∞–µ–º Flask –≤—Ä–µ–º—è –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    time.sleep(3)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    try:
        run_scheduler()
    except Exception as e:
        logger.error(f"üíÄ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")




